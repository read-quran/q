<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البحث في القرآن الكريم</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="quran.png" type="image/png">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="menu-icon" onclick="toggleMenu()">☰</div>
        <div class="nav-links">
            <a href="https://read-quran.github.io/7izb/">الصفحة الرئيسية</a>
            <a href="https://read-quran.github.io/q">البحث في القرآن</a>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>البحث في القرآن الكريم</h1>
        </div>
        <div class="search-container">
            <input 
                type="text" 
                class="search-box" 
                id="searchInput" 
                placeholder="ادخل كلمة للبحث"
                onkeypress="if(event.key === 'Enter') searchQuran()"
                oninput="showSuggestions()"
            >
            <button onclick="searchQuran()">بحث</button>

            <div class="search-options">
                <label>
                    <input type="checkbox" id="searchWithTashkeel"> البحث بالتشكيل
                </label>
            </div>
            <div id="suggestions" class="suggestions"></div>
        </div>
        <div id="results" class="results"></div>
    </div>

    <script src="quran-data.js"></script>
    <script src="quran-tshkel.js"></script>
    <script>
        // وظيفة لإظهار/إخفاء القائمة في الهواتف
        function toggleMenu() {
            const navLinks = document.querySelector('.navbar .nav-links');
            navLinks.classList.toggle('active');
        }

        // تحليل البيانات مباشرة عند تحميل الصفحة
        const parser = new DOMParser();
        const quranXMLDoc = parser.parseFromString(quranData, 'text/xml');
        const quranTashkeelXMLDoc = parser.parseFromString(quranTashkeelData, 'text/xml');

        // عرض الاقتراحات أثناء الكتابة
        function showSuggestions() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';

            if (searchTerm.length < 2) return;

            const suggestions = [];
            const suras = quranXMLDoc.getElementsByTagName('sura');
            for (let sura of suras) {
                const ayas = sura.getElementsByTagName('aya');
                for (let aya of ayas) {
                    const ayaText = aya.getAttribute('text');
                    if (ayaText.includes(searchTerm)) {
                        suggestions.push(ayaText);
                        if (suggestions.length >= 5) break; // عرض 5 اقتراحات فقط
                    }
                }
            }

            suggestions.forEach(suggestion => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = suggestion;
                suggestionItem.onclick = () => {
                    document.getElementById('searchInput').value = suggestion;
                    suggestionsDiv.innerHTML = '';
                };
                suggestionsDiv.appendChild(suggestionItem);
            });
        }

        function searchQuran() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const searchWithTashkeel = document.getElementById('searchWithTashkeel').checked;

            if (!searchTerm) {
                alert('الرجاء إدخال كلمة للبحث');
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">جاري البحث...</div>';

            setTimeout(() => performSearch(searchTerm, searchWithTashkeel), 100);
        }

function performSearch(searchTerm, searchWithTashkeel) {
    const results = document.getElementById('results');
    results.innerHTML = '';

    const suras = quranXMLDoc.getElementsByTagName('sura');
    const surasTashkeel = quranTashkeelXMLDoc.getElementsByTagName('sura');
    let found = false;
    let totalResults = 0;
    let searchResults = [];

    for (let sura of suras) {
        const suraIndex = sura.getAttribute('index');
        const suraName = sura.getAttribute('name');
        const ayas = sura.getElementsByTagName('aya');

        let suraResults = [];

        for (let aya of ayas) {
            const ayaIndex = aya.getAttribute('index');
            const ayaText = aya.getAttribute('text');
            const bismillah = aya.getAttribute('bismillah');

            if (ayaText.indexOf(searchTerm) !== -1) {
                // البحث في ملف التشكيل للحصول على النص المشكل
                const ayaTashkeel = getAyaWithTashkeel(suraIndex, ayaIndex, surasTashkeel);
                suraResults.push({
                    ayaIndex,
                    ayaText: searchWithTashkeel ? ayaTashkeel : ayaText,
                    bismillah
                });
                totalResults++;
            }
        }

        if (suraResults.length > 0) {
            searchResults.push({
                suraIndex,
                suraName,
                results: suraResults
            });
            found = true;
        }
    }

    if (!found) {
        results.innerHTML = '<div class="no-results">لا توجد نتائج للبحث</div>';
        return;
    }

    // إضافة إحصائيات البحث
    const statsDiv = document.createElement('div');
    statsDiv.className = 'search-stats';
    statsDiv.innerHTML = `تم العثور على ${totalResults} نتيجة في ${searchResults.length} سورة`;
    results.appendChild(statsDiv);

    // إضافة عبارة "اضغط على الآية مطولاً لنسخها"
    const copyInstructionDiv = document.createElement('div');
    copyInstructionDiv.className = 'copy-instruction';
    copyInstructionDiv.textContent = 'اضغط على الآية مطولاً لنسخها';
    results.appendChild(copyInstructionDiv);

    // عرض النتائج
    searchResults.forEach(sura => {
        const suraContainer = document.createElement('div');
        suraContainer.className = 'sura-container';
        
        suraContainer.innerHTML = `
            <div class="sura-name">سورة ${sura.suraName} (${sura.suraIndex})</div>
        `;

        sura.results.forEach(result => {
            if (result.bismillah) {
                suraContainer.innerHTML += `
                    <div class="bismillah">${result.bismillah}</div>
                `;
            }

            const highlightedText = highlightSearchTerm(result.ayaText, searchTerm);
            
            suraContainer.innerHTML += `
                <div class="aya-container" data-text="${result.ayaText.replace(/'/g, "\\'")}">
                    <span class="aya-number">آية ${result.ayaIndex}</span>
                    ${highlightedText}
                </div>
            `;
        });

        results.appendChild(suraContainer);
    });

    // إضافة حدث النقر المطول للنسخ
    addCopyEventListeners();
}

        function getAyaWithTashkeel(suraIndex, ayaIndex, surasTashkeel) {
            for (let sura of surasTashkeel) {
                if (sura.getAttribute('index') === suraIndex) {
                    const ayas = sura.getElementsByTagName('aya');
                    for (let aya of ayas) {
                        if (aya.getAttribute('index') === ayaIndex) {
                            return aya.getAttribute('text');
                        }
                    }
                }
            }
            return '';
        }

        function highlightSearchTerm(text, searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlighted">$1</span>');
        }

        function addCopyEventListeners() {
            const ayaContainers = document.querySelectorAll('.aya-container');
            ayaContainers.forEach(aya => {
                let pressTimer;
                aya.addEventListener('touchstart', (e) => {
                    pressTimer = setTimeout(() => {
                        copyToClipboard(aya.getAttribute('data-text'));
                    }, 1000); // النقر المطول لمدة ثانية
                });

                aya.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                });

                aya.addEventListener('mousedown', (e) => {
                    pressTimer = setTimeout(() => {
                        copyToClipboard(aya.getAttribute('data-text'));
                    }, 1000); // النقر المطول لمدة ثانية
                });

                aya.addEventListener('mouseup', () => {
                    clearTimeout(pressTimer);
                });
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('تم نسخ الآية بنجاح');
            }).catch(err => {
                console.error('فشل في النسخ: ', err);
            });
        }

        // تنفيذ البحث عند الضغط على Enter
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchQuran();
            }
        });
    </script>
</body>
</html>
